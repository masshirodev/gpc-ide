import { widgetSetPixel } from './types';

/**
 * 5x7 bitmap font for OLED preview rendering.
 * Each character is an array of 7 row values, each 5 bits wide (MSB = leftmost pixel).
 * Character pitch: 6px (5px glyph + 1px spacing).
 */
const FONT_WIDTH = 5;
const FONT_HEIGHT = 7;
const CHAR_PITCH = 6; // width + 1px spacing

// Printable ASCII 32–126 packed into a flat array (95 chars × 7 rows)
// prettier-ignore
const GLYPH_DATA: number[][] = [
	/* 32 ' ' */ [0b00000, 0b00000, 0b00000, 0b00000, 0b00000, 0b00000, 0b00000],
	/* 33 '!' */ [0b00100, 0b00100, 0b00100, 0b00100, 0b00100, 0b00000, 0b00100],
	/* 34 '"' */ [0b01010, 0b01010, 0b01010, 0b00000, 0b00000, 0b00000, 0b00000],
	/* 35 '#' */ [0b01010, 0b01010, 0b11111, 0b01010, 0b11111, 0b01010, 0b01010],
	/* 36 '$' */ [0b00100, 0b01111, 0b10100, 0b01110, 0b00101, 0b11110, 0b00100],
	/* 37 '%' */ [0b11000, 0b11001, 0b00010, 0b00100, 0b01000, 0b10011, 0b00011],
	/* 38 '&' */ [0b01100, 0b10010, 0b10100, 0b01000, 0b10101, 0b10010, 0b01101],
	/* 39 "'" */ [0b00100, 0b00100, 0b00100, 0b00000, 0b00000, 0b00000, 0b00000],
	/* 40 '(' */ [0b00010, 0b00100, 0b01000, 0b01000, 0b01000, 0b00100, 0b00010],
	/* 41 ')' */ [0b01000, 0b00100, 0b00010, 0b00010, 0b00010, 0b00100, 0b01000],
	/* 42 '*' */ [0b00000, 0b00100, 0b10101, 0b01110, 0b10101, 0b00100, 0b00000],
	/* 43 '+' */ [0b00000, 0b00100, 0b00100, 0b11111, 0b00100, 0b00100, 0b00000],
	/* 44 ',' */ [0b00000, 0b00000, 0b00000, 0b00000, 0b00100, 0b00100, 0b01000],
	/* 45 '-' */ [0b00000, 0b00000, 0b00000, 0b11111, 0b00000, 0b00000, 0b00000],
	/* 46 '.' */ [0b00000, 0b00000, 0b00000, 0b00000, 0b00000, 0b01100, 0b01100],
	/* 47 '/' */ [0b00001, 0b00010, 0b00010, 0b00100, 0b01000, 0b01000, 0b10000],
	/* 48 '0' */ [0b01110, 0b10001, 0b10011, 0b10101, 0b11001, 0b10001, 0b01110],
	/* 49 '1' */ [0b00100, 0b01100, 0b00100, 0b00100, 0b00100, 0b00100, 0b01110],
	/* 50 '2' */ [0b01110, 0b10001, 0b00001, 0b00110, 0b01000, 0b10000, 0b11111],
	/* 51 '3' */ [0b01110, 0b10001, 0b00001, 0b00110, 0b00001, 0b10001, 0b01110],
	/* 52 '4' */ [0b00010, 0b00110, 0b01010, 0b10010, 0b11111, 0b00010, 0b00010],
	/* 53 '5' */ [0b11111, 0b10000, 0b11110, 0b00001, 0b00001, 0b10001, 0b01110],
	/* 54 '6' */ [0b00110, 0b01000, 0b10000, 0b11110, 0b10001, 0b10001, 0b01110],
	/* 55 '7' */ [0b11111, 0b00001, 0b00010, 0b00100, 0b01000, 0b01000, 0b01000],
	/* 56 '8' */ [0b01110, 0b10001, 0b10001, 0b01110, 0b10001, 0b10001, 0b01110],
	/* 57 '9' */ [0b01110, 0b10001, 0b10001, 0b01111, 0b00001, 0b00010, 0b01100],
	/* 58 ':' */ [0b00000, 0b01100, 0b01100, 0b00000, 0b01100, 0b01100, 0b00000],
	/* 59 ';' */ [0b00000, 0b01100, 0b01100, 0b00000, 0b00100, 0b00100, 0b01000],
	/* 60 '<' */ [0b00010, 0b00100, 0b01000, 0b10000, 0b01000, 0b00100, 0b00010],
	/* 61 '=' */ [0b00000, 0b00000, 0b11111, 0b00000, 0b11111, 0b00000, 0b00000],
	/* 62 '>' */ [0b01000, 0b00100, 0b00010, 0b00001, 0b00010, 0b00100, 0b01000],
	/* 63 '?' */ [0b01110, 0b10001, 0b00001, 0b00010, 0b00100, 0b00000, 0b00100],
	/* 64 '@' */ [0b01110, 0b10001, 0b10111, 0b10101, 0b10110, 0b10000, 0b01110],
	/* 65 'A' */ [0b01110, 0b10001, 0b10001, 0b11111, 0b10001, 0b10001, 0b10001],
	/* 66 'B' */ [0b11110, 0b10001, 0b10001, 0b11110, 0b10001, 0b10001, 0b11110],
	/* 67 'C' */ [0b01110, 0b10001, 0b10000, 0b10000, 0b10000, 0b10001, 0b01110],
	/* 68 'D' */ [0b11110, 0b10001, 0b10001, 0b10001, 0b10001, 0b10001, 0b11110],
	/* 69 'E' */ [0b11111, 0b10000, 0b10000, 0b11110, 0b10000, 0b10000, 0b11111],
	/* 70 'F' */ [0b11111, 0b10000, 0b10000, 0b11110, 0b10000, 0b10000, 0b10000],
	/* 71 'G' */ [0b01110, 0b10001, 0b10000, 0b10111, 0b10001, 0b10001, 0b01111],
	/* 72 'H' */ [0b10001, 0b10001, 0b10001, 0b11111, 0b10001, 0b10001, 0b10001],
	/* 73 'I' */ [0b01110, 0b00100, 0b00100, 0b00100, 0b00100, 0b00100, 0b01110],
	/* 74 'J' */ [0b00111, 0b00010, 0b00010, 0b00010, 0b00010, 0b10010, 0b01100],
	/* 75 'K' */ [0b10001, 0b10010, 0b10100, 0b11000, 0b10100, 0b10010, 0b10001],
	/* 76 'L' */ [0b10000, 0b10000, 0b10000, 0b10000, 0b10000, 0b10000, 0b11111],
	/* 77 'M' */ [0b10001, 0b11011, 0b10101, 0b10101, 0b10001, 0b10001, 0b10001],
	/* 78 'N' */ [0b10001, 0b11001, 0b10101, 0b10101, 0b10011, 0b10001, 0b10001],
	/* 79 'O' */ [0b01110, 0b10001, 0b10001, 0b10001, 0b10001, 0b10001, 0b01110],
	/* 80 'P' */ [0b11110, 0b10001, 0b10001, 0b11110, 0b10000, 0b10000, 0b10000],
	/* 81 'Q' */ [0b01110, 0b10001, 0b10001, 0b10001, 0b10101, 0b10010, 0b01101],
	/* 82 'R' */ [0b11110, 0b10001, 0b10001, 0b11110, 0b10100, 0b10010, 0b10001],
	/* 83 'S' */ [0b01110, 0b10001, 0b10000, 0b01110, 0b00001, 0b10001, 0b01110],
	/* 84 'T' */ [0b11111, 0b00100, 0b00100, 0b00100, 0b00100, 0b00100, 0b00100],
	/* 85 'U' */ [0b10001, 0b10001, 0b10001, 0b10001, 0b10001, 0b10001, 0b01110],
	/* 86 'V' */ [0b10001, 0b10001, 0b10001, 0b10001, 0b01010, 0b01010, 0b00100],
	/* 87 'W' */ [0b10001, 0b10001, 0b10001, 0b10101, 0b10101, 0b11011, 0b10001],
	/* 88 'X' */ [0b10001, 0b10001, 0b01010, 0b00100, 0b01010, 0b10001, 0b10001],
	/* 89 'Y' */ [0b10001, 0b10001, 0b01010, 0b00100, 0b00100, 0b00100, 0b00100],
	/* 90 'Z' */ [0b11111, 0b00001, 0b00010, 0b00100, 0b01000, 0b10000, 0b11111],
	/* 91 '[' */ [0b01110, 0b01000, 0b01000, 0b01000, 0b01000, 0b01000, 0b01110],
	/* 92 '\' */ [0b10000, 0b01000, 0b01000, 0b00100, 0b00010, 0b00010, 0b00001],
	/* 93 ']' */ [0b01110, 0b00010, 0b00010, 0b00010, 0b00010, 0b00010, 0b01110],
	/* 94 '^' */ [0b00100, 0b01010, 0b10001, 0b00000, 0b00000, 0b00000, 0b00000],
	/* 95 '_' */ [0b00000, 0b00000, 0b00000, 0b00000, 0b00000, 0b00000, 0b11111],
	/* 96 '`' */ [0b01000, 0b00100, 0b00010, 0b00000, 0b00000, 0b00000, 0b00000],
	/* 97 'a' */ [0b00000, 0b00000, 0b01110, 0b00001, 0b01111, 0b10001, 0b01111],
	/* 98 'b' */ [0b10000, 0b10000, 0b11110, 0b10001, 0b10001, 0b10001, 0b11110],
	/* 99 'c' */ [0b00000, 0b00000, 0b01110, 0b10000, 0b10000, 0b10001, 0b01110],
	/*100 'd' */ [0b00001, 0b00001, 0b01111, 0b10001, 0b10001, 0b10001, 0b01111],
	/*101 'e' */ [0b00000, 0b00000, 0b01110, 0b10001, 0b11111, 0b10000, 0b01110],
	/*102 'f' */ [0b00110, 0b01001, 0b01000, 0b11100, 0b01000, 0b01000, 0b01000],
	/*103 'g' */ [0b00000, 0b01111, 0b10001, 0b10001, 0b01111, 0b00001, 0b01110],
	/*104 'h' */ [0b10000, 0b10000, 0b10110, 0b11001, 0b10001, 0b10001, 0b10001],
	/*105 'i' */ [0b00100, 0b00000, 0b01100, 0b00100, 0b00100, 0b00100, 0b01110],
	/*106 'j' */ [0b00010, 0b00000, 0b00110, 0b00010, 0b00010, 0b10010, 0b01100],
	/*107 'k' */ [0b10000, 0b10000, 0b10010, 0b10100, 0b11000, 0b10100, 0b10010],
	/*108 'l' */ [0b01100, 0b00100, 0b00100, 0b00100, 0b00100, 0b00100, 0b01110],
	/*109 'm' */ [0b00000, 0b00000, 0b11010, 0b10101, 0b10101, 0b10001, 0b10001],
	/*110 'n' */ [0b00000, 0b00000, 0b10110, 0b11001, 0b10001, 0b10001, 0b10001],
	/*111 'o' */ [0b00000, 0b00000, 0b01110, 0b10001, 0b10001, 0b10001, 0b01110],
	/*112 'p' */ [0b00000, 0b00000, 0b11110, 0b10001, 0b11110, 0b10000, 0b10000],
	/*113 'q' */ [0b00000, 0b00000, 0b01111, 0b10001, 0b01111, 0b00001, 0b00001],
	/*114 'r' */ [0b00000, 0b00000, 0b10110, 0b11001, 0b10000, 0b10000, 0b10000],
	/*115 's' */ [0b00000, 0b00000, 0b01111, 0b10000, 0b01110, 0b00001, 0b11110],
	/*116 't' */ [0b01000, 0b01000, 0b11100, 0b01000, 0b01000, 0b01001, 0b00110],
	/*117 'u' */ [0b00000, 0b00000, 0b10001, 0b10001, 0b10001, 0b10011, 0b01101],
	/*118 'v' */ [0b00000, 0b00000, 0b10001, 0b10001, 0b10001, 0b01010, 0b00100],
	/*119 'w' */ [0b00000, 0b00000, 0b10001, 0b10001, 0b10101, 0b10101, 0b01010],
	/*120 'x' */ [0b00000, 0b00000, 0b10001, 0b01010, 0b00100, 0b01010, 0b10001],
	/*121 'y' */ [0b00000, 0b00000, 0b10001, 0b10001, 0b01111, 0b00001, 0b01110],
	/*122 'z' */ [0b00000, 0b00000, 0b11111, 0b00010, 0b00100, 0b01000, 0b11111],
	/*123 '{' */ [0b00010, 0b00100, 0b00100, 0b01000, 0b00100, 0b00100, 0b00010],
	/*124 '|' */ [0b00100, 0b00100, 0b00100, 0b00100, 0b00100, 0b00100, 0b00100],
	/*125 '}' */ [0b01000, 0b00100, 0b00100, 0b00010, 0b00100, 0b00100, 0b01000],
	/*126 '~' */ [0b00000, 0b00000, 0b01000, 0b10101, 0b00010, 0b00000, 0b00000],
];

/**
 * Draw a single character glyph onto a pixel buffer.
 */
function drawChar(
	pixels: Uint8Array,
	charCode: number,
	x: number,
	y: number,
	on: boolean = true
): void {
	const idx = charCode - 32;
	if (idx < 0 || idx >= GLYPH_DATA.length) return;
	const rows = GLYPH_DATA[idx];
	for (let row = 0; row < FONT_HEIGHT; row++) {
		const bits = rows[row];
		for (let col = 0; col < FONT_WIDTH; col++) {
			if (bits & (1 << (FONT_WIDTH - 1 - col))) {
				widgetSetPixel(pixels, x + col, y + row, on);
			}
		}
	}
}

/**
 * Draw a text string onto a pixel buffer using the 5x7 bitmap font.
 * Returns the total width in pixels drawn.
 */
export function drawBitmapText(
	pixels: Uint8Array,
	text: string,
	x: number,
	y: number,
	on: boolean = true
): number {
	let cx = x;
	for (let i = 0; i < text.length; i++) {
		drawChar(pixels, text.charCodeAt(i), cx, y, on);
		cx += CHAR_PITCH;
	}
	return text.length * CHAR_PITCH;
}

/** Measure text width in pixels (5x7 font, 6px pitch). */
export function measureText(text: string): number {
	return text.length * CHAR_PITCH;
}

export { CHAR_PITCH, FONT_WIDTH, FONT_HEIGHT };
