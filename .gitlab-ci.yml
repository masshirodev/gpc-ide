stages:
  - build

variables:
  RUST_VERSION: "stable"
  NODE_VERSION: "22"

build-linux:
  stage: build
  image: rust:latest
  before_script:
    - apt-get update && apt-get install -y
        libwebkit2gtk-4.1-dev
        libgtk-3-dev
        libayatana-appindicator3-dev
        librsvg2-dev
        patchelf
        curl
        wget
    - curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash -
    - apt-get install -y nodejs
    - npm ci
  script:
    - npx tauri build --bundles deb,rpm
  artifacts:
    paths:
      - src-tauri/target/release/gpc-ide
      - src-tauri/target/release/bundle/deb/*.deb
      - src-tauri/target/release/bundle/rpm/*.rpm
    expire_in: 30 days

build-windows:
  stage: build
  tags:
    - windows
  before_script:
    - rustup default stable
    - choco install nodejs-lts -y --no-progress
    - refreshenv
    - npm ci
  script:
    - npx tauri build --bundles nsis
  artifacts:
    paths:
      - src-tauri/target/release/gpc-ide.exe
      - src-tauri/target/release/bundle/nsis/*.exe
    expire_in: 30 days
