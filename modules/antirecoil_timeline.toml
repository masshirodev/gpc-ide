[antirecoil_timeline]
display_name = "Anti Recoil (Timeline)"
id = "antirecoil_timeline"
type = "fps"
description = "Per-weapon anti-recoil with 10-phase recoil curves.\nUses const WeaponRecoilTable[][] from recoiltable.gpc for time-based corrections.\nPer-weapon V/H modifiers editable via OLED submenu."
state_display = "AR"
status_var = "AntiRecoilStatus"
has_quick_toggle = true
needs_weapondata = true
needs_recoiltable = true
conflicts = [
    "antirecoil",
    "antirecoil_decay",
]
trigger = "// Anti-recoil (phase-based) with per-weapon recoil curves\nif (AntiRecoilStatus && get_val(PS5_L2) && get_val(PS5_R2)) {\n    AntiRecoil_Timer++;\n    if (AntiRecoil_Timer >= ANTIRECOIL_INIT_DELAY) {\n        combo_run(AntiRecoilTimeline);\n    }\n} else {\n    AntiRecoil_Timer = 0;\n}"
combo = "define ANTIRECOIL_INIT_DELAY = 15;  // Skip first ~150ms of firing (minimal recoil)\n\nfunction GetRecoilPhase(fireTime) {\n    if (fireTime <= RECOIL_PHASE_0_END) { return 0; }\n    if (fireTime <= RECOIL_PHASE_1_END) { return 1; }\n    if (fireTime <= RECOIL_PHASE_2_END) { return 2; }\n    if (fireTime <= RECOIL_PHASE_3_END) { return 3; }\n    if (fireTime <= RECOIL_PHASE_4_END) { return 4; }\n    if (fireTime <= RECOIL_PHASE_5_END) { return 5; }\n    if (fireTime <= RECOIL_PHASE_6_END) { return 6; }\n    if (fireTime <= RECOIL_PHASE_7_END) { return 7; }\n    if (fireTime <= RECOIL_PHASE_8_END) { return 8; }\n    return 9;\n}\n\nfunction LoadRecoilPhases(weapon_id) {\n    for (_current_phase = 0; _current_phase < RECOIL_PHASES; _current_phase++) {\n        _recoil_phase_v[_current_phase] = WeaponRecoilTable[weapon_id][_current_phase * 2];\n        _recoil_phase_h[_current_phase] = WeaponRecoilTable[weapon_id][_current_phase * 2 + 1];\n    }\n    // Carry-forward: if phase N is 0 and phase N-1 is non-zero, inherit\n    for (_current_phase = 1; _current_phase < RECOIL_PHASES; _current_phase++) {\n        if (_recoil_phase_v[_current_phase] == 0 && _recoil_phase_v[_current_phase - 1] != 0) {\n            _recoil_phase_v[_current_phase] = _recoil_phase_v[_current_phase - 1];\n        }\n        if (_recoil_phase_h[_current_phase] == 0 && _recoil_phase_h[_current_phase - 1] != 0) {\n            _recoil_phase_h[_current_phase] = _recoil_phase_h[_current_phase - 1];\n        }\n    }\n    _last_recoil_weapon = weapon_id;\n}\n\ncombo AntiRecoilTimeline {\n    active_weapon = GetActiveWeapon();\n\n    // Load phase data when weapon changes\n    if (active_weapon != _last_recoil_weapon) {\n        LoadRecoilPhases(active_weapon);\n    }\n\n    // Determine current phase from fire timer\n    _current_phase = GetRecoilPhase(AntiRecoil_Timer);\n\n    // Phase recoil + per-weapon menu modifier\n    Recoil_Vertical = _recoil_phase_v[_current_phase] + Weapons_RecoilValues[active_weapon * 2];\n    Recoil_Horizontal = _recoil_phase_h[_current_phase] + Weapons_RecoilValues[active_weapon * 2 + 1];\n\n    // Advance LCG seed every cycle for well-distributed variance\n    _jitter_seed = (_jitter_seed * 1103515245 + 12345) ^ get_rtime();\n\n    // Per-cycle variance: +/-15% of base value, V and H derived independently\n    random_variance_v = (abs(_jitter_seed) % 31) - 15;\n    random_variance_h = (abs(_jitter_seed / 31) % 23) - 11;\n\n    // Apply recoil correction with randomness\n    if (Recoil_Vertical != 0) {\n        set_val(PS5_RY, clamp(get_val(PS5_RY) + Recoil_Vertical + (random_variance_v * abs(Recoil_Vertical) / 100), -100, 100));\n    }\n    if (Recoil_Horizontal != 0) {\n        set_val(PS5_RX, clamp(get_val(PS5_RX) + Recoil_Horizontal + (random_variance_h * abs(Recoil_Horizontal) / 100), -100, 100));\n    }\n}\n\nfunction AntiRecoilTimeline_RenderSubmenu() {\n    Clear();\n    XSelect(rect_y);\n\n    AR_EditWeapon = GetActiveWeapon();\n\n    // Row 1: Status toggle\n    print(32, 11, OLED_FONT_SMALL, OLED_WHITE, AntiRecoilTimeline_OptionText[0]);\n    drawing_toggle(110, 11, AntiRecoilStatus);\n    if (rect_y == 12) {\n        if (event_press(RIGHT_BTN) || event_press(LEFT_BTN)) {\n            AntiRecoilStatus = !AntiRecoilStatus;\n        }\n    }\n\n    // Row 2: Vertical modifier for current weapon\n    print(32, 27, OLED_FONT_SMALL, OLED_WHITE, AntiRecoilTimeline_OptionText[1]);\n    PrintNumber(Weapons_RecoilValues[AR_EditWeapon * 2], find_digits(abs(Weapons_RecoilValues[AR_EditWeapon * 2])) + 1, 98, 27, OLED_FONT_SMALL);\n    if (rect_y == 28) {\n        if (get_val(ADS_BTN) && event_press(RIGHT_BTN)) { Weapons_RecoilValues[AR_EditWeapon * 2] += 10; }\n        else if (event_press(RIGHT_BTN)) { Weapons_RecoilValues[AR_EditWeapon * 2]++; }\n        if (get_val(ADS_BTN) && event_press(LEFT_BTN)) { Weapons_RecoilValues[AR_EditWeapon * 2] -= 10; }\n        else if (event_press(LEFT_BTN)) { Weapons_RecoilValues[AR_EditWeapon * 2]--; }\n    }\n\n    // Row 3: Horizontal modifier for current weapon\n    print(32, 43, OLED_FONT_SMALL, OLED_WHITE, AntiRecoilTimeline_OptionText[2]);\n    PrintNumber(Weapons_RecoilValues[AR_EditWeapon * 2 + 1], find_digits(abs(Weapons_RecoilValues[AR_EditWeapon * 2 + 1])) + 1, 98, 43, OLED_FONT_SMALL);\n    if (rect_y == 44) {\n        if (get_val(ADS_BTN) && event_press(RIGHT_BTN)) { Weapons_RecoilValues[AR_EditWeapon * 2 + 1] += 10; }\n        else if (event_press(RIGHT_BTN)) { Weapons_RecoilValues[AR_EditWeapon * 2 + 1]++; }\n        if (get_val(ADS_BTN) && event_press(LEFT_BTN)) { Weapons_RecoilValues[AR_EditWeapon * 2 + 1] -= 10; }\n        else if (event_press(LEFT_BTN)) { Weapons_RecoilValues[AR_EditWeapon * 2 + 1]--; }\n    }\n\n    // Navigation\n    if (event_press(UP_BTN)) { rect_y -= 16; }\n    if (event_press(DOWN_BTN)) { rect_y += 16; }\n    if (rect_y < 12) { rect_y = 12; }\n    if (rect_y > 44) { rect_y = 44; }\n\n    // Value bounds\n    if (Weapons_RecoilValues[AR_EditWeapon * 2] < -100) { Weapons_RecoilValues[AR_EditWeapon * 2] = -100; }\n    if (Weapons_RecoilValues[AR_EditWeapon * 2] > 100) { Weapons_RecoilValues[AR_EditWeapon * 2] = 100; }\n    if (Weapons_RecoilValues[AR_EditWeapon * 2 + 1] < -100) { Weapons_RecoilValues[AR_EditWeapon * 2 + 1] = -100; }\n    if (Weapons_RecoilValues[AR_EditWeapon * 2 + 1] > 100) { Weapons_RecoilValues[AR_EditWeapon * 2 + 1] = 100; }\n\n    // Exit\n    if (event_press(CANCEL_BTN)) {\n        Menu = 1;\n        rect_y = 12;\n        _CoreSave();\n    }\n}"
options = [
    { name = "Status", var = "AntiRecoilStatus", type = "toggle", default = 0 },
    { name = "V Mod.", var = "AR_TempV", type = "value", default = 0, min = -100, max = 100 },
    { name = "H Mod.", var = "AR_TempH", type = "value", default = 0, min = -100, max = 100 },
]

[antirecoil_timeline.config_menu]
name = "Anti Recoil (Timeline)"
type = "clickable"
render_function = "AntiRecoilTimeline_RenderSubmenu"

[antirecoil_timeline.extra_vars]
random_variance_v = "int"
random_variance_h = "int"
AntiRecoil_Timer = "int"
Recoil_Vertical = "int"
Recoil_Horizontal = "int"
active_weapon = "int"
AR_EditWeapon = "int"
_recoil_phase_v = "int [10]"
_recoil_phase_h = "int [10]"
_last_recoil_weapon = "int"
_current_phase = "int"
