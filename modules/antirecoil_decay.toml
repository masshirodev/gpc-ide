[antirecoil_decay]
display_name = "Anti Recoil (Decay)"
id = "antirecoil_decay"
type = "fps"
description = "Per-weapon anti-recoil with gradual decay on sustained fire.\nAfter a configurable delay, recoil compensation gradually reduces to a floor value.\nUses per-weapon V/H values from weapon data."
state_display = "AR"
status_var = "AntiRecoilStatus"
has_quick_toggle = true
needs_weapondata = true
conflicts = [
    "antirecoil",
    "antirecoil_timeline",
]
trigger = "// Anti-recoil (decay) with per-weapon values\nif (AntiRecoilStatus && get_val(PS5_L2) && get_val(PS5_R2)) {\n    AntiRecoil_Timer++;\n    if (AntiRecoil_Timer >= ANTIRECOIL_INIT_DELAY) {\n        combo_run(AntiRecoilDecay);\n    }\n} else {\n    AntiRecoil_Timer = 0;\n    AR_DecayCycles = 0;\n}"
combo = "define ANTIRECOIL_INIT_DELAY = 15;  // Skip first ~150ms of firing (minimal recoil)\n\ncombo AntiRecoilDecay {\n    active_weapon = GetActiveWeapon();\n\n    // Base recoil values from weapon data\n    Recoil_Vertical = Weapons_RecoilValues[active_weapon * 2];\n    Recoil_Horizontal = Weapons_RecoilValues[active_weapon * 2 + 1];\n\n    // Apply decay after sustained fire\n    AR_DecayCycles++;\n    if (AR_DecayCycles > AR_DecayStart) {\n        AR_DecayMult = 100 - ((AR_DecayCycles - AR_DecayStart) * AR_DecayRate);\n        if (AR_DecayMult < AR_DecayFloor) { AR_DecayMult = AR_DecayFloor; }\n        Recoil_Vertical = (Recoil_Vertical * AR_DecayMult) / 100;\n        Recoil_Horizontal = (Recoil_Horizontal * AR_DecayMult) / 100;\n    }\n\n    // Advance LCG seed every cycle for well-distributed variance\n    _jitter_seed = (_jitter_seed * 1103515245 + 12345) ^ get_rtime();\n\n    // Per-cycle variance: Â±15% of base value, V and H derived independently\n    random_variance_v = (abs(_jitter_seed) % 31) - 15;\n    random_variance_h = (abs(_jitter_seed / 31) % 23) - 11;\n\n    // Apply recoil correction with randomness\n    if (Recoil_Vertical != 0) {\n        set_val(PS5_RY, clamp(get_val(PS5_RY) + Recoil_Vertical + (random_variance_v * abs(Recoil_Vertical) / 100), -100, 100));\n    }\n    if (Recoil_Horizontal != 0) {\n        set_val(PS5_RX, clamp(get_val(PS5_RX) + Recoil_Horizontal + (random_variance_h * abs(Recoil_Horizontal) / 100), -100, 100));\n    }\n}\n\nfunction AntiRecoilDecay_RenderSubmenu() {\n    Clear();\n\n    if (AntiRecoilDecay_SubPage == 0) {\n        // Page 0: Status + per-weapon V/H editing\n        draw_scroll_dynamic(AntiRecoilDecay_SubPage, 1);\n        XSelect(rect_y);\n\n        AR_EditWeapon = GetActiveWeapon();\n\n        // Row 1: Status toggle\n        print(32, 11, OLED_FONT_SMALL, OLED_WHITE, AntiRecoilDecay_OptionText[0]);\n        drawing_toggle(110, 11, AntiRecoilStatus);\n        if (rect_y == 12) {\n            if (event_press(RIGHT_BTN) || event_press(LEFT_BTN)) {\n                AntiRecoilStatus = !AntiRecoilStatus;\n            }\n        }\n\n        // Row 2: Vertical recoil for current weapon\n        print(32, 27, OLED_FONT_SMALL, OLED_WHITE, AntiRecoilDecay_OptionText[1]);\n        PrintNumber(Weapons_RecoilValues[AR_EditWeapon * 2], find_digits(abs(Weapons_RecoilValues[AR_EditWeapon * 2])) + 1, 98, 27, OLED_FONT_SMALL);\n        if (rect_y == 28) {\n            if (get_val(ADS_BTN) && event_press(RIGHT_BTN)) { Weapons_RecoilValues[AR_EditWeapon * 2] += 10; }\n            else if (event_press(RIGHT_BTN)) { Weapons_RecoilValues[AR_EditWeapon * 2]++; }\n            if (get_val(ADS_BTN) && event_press(LEFT_BTN)) { Weapons_RecoilValues[AR_EditWeapon * 2] -= 10; }\n            else if (event_press(LEFT_BTN)) { Weapons_RecoilValues[AR_EditWeapon * 2]--; }\n        }\n\n        // Row 3: Horizontal recoil for current weapon\n        print(32, 43, OLED_FONT_SMALL, OLED_WHITE, AntiRecoilDecay_OptionText[2]);\n        PrintNumber(Weapons_RecoilValues[AR_EditWeapon * 2 + 1], find_digits(abs(Weapons_RecoilValues[AR_EditWeapon * 2 + 1])) + 1, 98, 43, OLED_FONT_SMALL);\n        if (rect_y == 44) {\n            if (get_val(ADS_BTN) && event_press(RIGHT_BTN)) { Weapons_RecoilValues[AR_EditWeapon * 2 + 1] += 10; }\n            else if (event_press(RIGHT_BTN)) { Weapons_RecoilValues[AR_EditWeapon * 2 + 1]++; }\n            if (get_val(ADS_BTN) && event_press(LEFT_BTN)) { Weapons_RecoilValues[AR_EditWeapon * 2 + 1] -= 10; }\n            else if (event_press(LEFT_BTN)) { Weapons_RecoilValues[AR_EditWeapon * 2 + 1]--; }\n        }\n    } else {\n        // Page 1: Decay parameters\n        draw_scroll_dynamic(AntiRecoilDecay_SubPage, 1);\n        XSelect(rect_y);\n\n        // Row 1: Decay Start\n        print(32, 11, OLED_FONT_SMALL, OLED_WHITE, AntiRecoilDecay_OptionText[3]);\n        PrintNumber(AR_DecayStart, find_digits(AR_DecayStart), 98, 11, OLED_FONT_SMALL);\n        if (rect_y == 12) {\n            if (get_val(ADS_BTN) && event_press(RIGHT_BTN)) { AR_DecayStart += 10; }\n            else if (event_press(RIGHT_BTN)) { AR_DecayStart++; }\n            if (get_val(ADS_BTN) && event_press(LEFT_BTN)) { AR_DecayStart -= 10; }\n            else if (event_press(LEFT_BTN)) { AR_DecayStart--; }\n        }\n\n        // Row 2: Decay Rate\n        print(32, 27, OLED_FONT_SMALL, OLED_WHITE, AntiRecoilDecay_OptionText[4]);\n        PrintNumber(AR_DecayRate, find_digits(AR_DecayRate), 98, 27, OLED_FONT_SMALL);\n        if (rect_y == 28) {\n            if (event_press(RIGHT_BTN)) { AR_DecayRate++; }\n            if (event_press(LEFT_BTN)) { AR_DecayRate--; }\n        }\n\n        // Row 3: Decay Floor\n        print(32, 43, OLED_FONT_SMALL, OLED_WHITE, AntiRecoilDecay_OptionText[5]);\n        PrintNumber(AR_DecayFloor, find_digits(AR_DecayFloor), 98, 43, OLED_FONT_SMALL);\n        if (rect_y == 44) {\n            if (get_val(ADS_BTN) && event_press(RIGHT_BTN)) { AR_DecayFloor += 10; }\n            else if (event_press(RIGHT_BTN)) { AR_DecayFloor++; }\n            if (get_val(ADS_BTN) && event_press(LEFT_BTN)) { AR_DecayFloor -= 10; }\n            else if (event_press(LEFT_BTN)) { AR_DecayFloor--; }\n        }\n    }\n\n    // Navigation\n    if (event_press(UP_BTN)) { rect_y -= 16; }\n    if (event_press(DOWN_BTN)) { rect_y += 16; }\n    if (rect_y < 12) { rect_y = 12; }\n    if (rect_y > 44) { rect_y = 44; }\n\n    // Page navigation at boundaries\n    if (rect_y > 44 && AntiRecoilDecay_SubPage < 1) {\n        AntiRecoilDecay_SubPage++;\n        rect_y = 12;\n    }\n    if (rect_y < 12 && AntiRecoilDecay_SubPage > 0) {\n        AntiRecoilDecay_SubPage--;\n        rect_y = 44;\n    }\n\n    // Value bounds\n    if (Weapons_RecoilValues[AR_EditWeapon * 2] < -100) { Weapons_RecoilValues[AR_EditWeapon * 2] = -100; }\n    if (Weapons_RecoilValues[AR_EditWeapon * 2] > 100) { Weapons_RecoilValues[AR_EditWeapon * 2] = 100; }\n    if (Weapons_RecoilValues[AR_EditWeapon * 2 + 1] < -100) { Weapons_RecoilValues[AR_EditWeapon * 2 + 1] = -100; }\n    if (Weapons_RecoilValues[AR_EditWeapon * 2 + 1] > 100) { Weapons_RecoilValues[AR_EditWeapon * 2 + 1] = 100; }\n    if (AR_DecayStart < 10) { AR_DecayStart = 10; }\n    if (AR_DecayStart > 300) { AR_DecayStart = 300; }\n    if (AR_DecayRate < 1) { AR_DecayRate = 1; }\n    if (AR_DecayRate > 10) { AR_DecayRate = 10; }\n    if (AR_DecayFloor < 10) { AR_DecayFloor = 10; }\n    if (AR_DecayFloor > 100) { AR_DecayFloor = 100; }\n\n    // Exit\n    if (event_press(CANCEL_BTN)) {\n        if (AntiRecoilDecay_SubPage > 0) {\n            AntiRecoilDecay_SubPage = 0;\n            rect_y = 12;\n        } else {\n            Menu = 1;\n            rect_y = 12;\n            AntiRecoilDecay_SubPage = 0;\n            _CoreSave();\n        }\n    }\n}"

[antirecoil_decay.config_menu]
name = "Anti Recoil (Decay)"
type = "clickable"
render_function = "AntiRecoilDecay_RenderSubmenu"

[[antirecoil_decay.options]]
name = "Status"
var = "AntiRecoilStatus"
type = "toggle"
default = 0

[[antirecoil_decay.options]]
name = "Vertical"
var = "AR_TempV"
type = "value"
default = 0
min = -100
max = 100

[[antirecoil_decay.options]]
name = "Horizontal"
var = "AR_TempH"
type = "value"
default = 0
min = -100
max = 100

[[antirecoil_decay.options]]
name = "Decay Start"
var = "AR_DecayStart"
type = "value"
default = 80
min = 10
max = 300

[[antirecoil_decay.options]]
name = "Decay Rate"
var = "AR_DecayRate"
type = "value"
default = 3
min = 1
max = 10

[[antirecoil_decay.options]]
name = "Decay Floor"
var = "AR_DecayFloor"
type = "value"
default = 20
min = 10
max = 100

[antirecoil_decay.extra_vars]
random_variance_v = "int"
random_variance_h = "int"
AntiRecoil_Timer = "int"
Recoil_Vertical = "int"
Recoil_Horizontal = "int"
active_weapon = "int"
AR_EditWeapon = "int"
AR_DecayCycles = "int"
AR_DecayMult = "int"
AntiRecoilDecay_SubPage = "int"
